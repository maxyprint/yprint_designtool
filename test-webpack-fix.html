<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webpack Canvas Singleton Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .canvas-container { background: white; padding: 20px; margin: 20px 0; border: 1px solid #ddd; }
        canvas { border: 2px solid #333; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        .debug-output { background: #000; color: #00ff00; font-family: monospace; padding: 20px; margin: 20px 0; height: 400px; overflow-y: scroll; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Webpack Canvas Singleton Fix Test</h1>

        <div class="test-section">
            <h2>üîç System Status</h2>
            <div id="system-status"></div>
            <button onclick="checkSystemStatus()">Check System Status</button>
        </div>

        <div class="test-section">
            <h2>üé® Canvas Test Area</h2>
            <div class="canvas-container">
                <canvas id="octo-print-designer-canvas" width="800" height="400"></canvas>
            </div>
            <button onclick="testCanvasCreation()">Test Canvas Creation</button>
            <button onclick="testDoubleInit()">Test Double Initialization</button>
            <button onclick="testWebpackImport()">Test Webpack Import Protection</button>
            <button onclick="clearCanvas()">Clear Canvas</button>
        </div>

        <div class="test-section">
            <h2>üíæ Save System Test</h2>
            <button onclick="testJSONGeneration()">Test JSON Generation</button>
            <button onclick="simulateSave()">Simulate Save Action</button>
            <button onclick="runSaveVerification()">üß™ Run Save Verification Suite</button>
        </div>

        <div class="test-section">
            <h2>üß™ Debug Console</h2>
            <div id="debug-output" class="debug-output"></div>
            <button onclick="clearDebugOutput()">Clear Debug Output</button>
        </div>
    </div>

    <script>
        let debugOutput = document.getElementById('debug-output');
        let systemStatus = document.getElementById('system-status');
        let testCanvas = null;

        // Enhanced console logging to capture all output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addDebugOutput(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warn' ? 'warning' : type === 'success' ? 'success' : 'info';
            debugOutput.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addDebugOutput(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addDebugOutput(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addDebugOutput(args.join(' '), 'warning');
        };

        function checkSystemStatus() {
            addDebugOutput('=== SYSTEM STATUS CHECK ===', 'info');

            let status = '<h3>üîç Component Status:</h3><ul>';

            // Canvas Singleton Manager
            const hasManager = typeof window.canvasSingletonManager !== 'undefined';
            status += `<li>Canvas Singleton Manager: <span class="${hasManager ? 'success' : 'error'}">${hasManager ? '‚úÖ LOADED' : '‚ùå MISSING'}</span></li>`;

            // Enhanced JSON System
            const hasJSONSystem = typeof window.enhancedJSONSystem !== 'undefined';
            status += `<li>Enhanced JSON System: <span class="${hasJSONSystem ? 'success' : 'error'}">${hasJSONSystem ? '‚úÖ LOADED' : '‚ùå MISSING'}</span></li>`;

            // Fabric.js availability
            const hasFabric = typeof window.fabric !== 'undefined' && window.fabric.Canvas;
            status += `<li>Fabric.js Global: <span class="${hasFabric ? 'success' : 'error'}">${hasFabric ? '‚úÖ AVAILABLE' : '‚ùå MISSING'}</span></li>`;

            // Webpack require
            const hasWebpack = typeof window.__webpack_require__ !== 'undefined';
            status += `<li>Webpack Require: <span class="${hasWebpack ? 'success' : 'warning'}">${hasWebpack ? '‚úÖ AVAILABLE' : '‚ö†Ô∏è NOT DETECTED'}</span></li>`;

            // DesignerWidget
            const hasDesignerWidget = typeof DesignerWidget !== 'undefined';
            status += `<li>DesignerWidget: <span class="${hasDesignerWidget ? 'success' : 'warning'}">${hasDesignerWidget ? '‚úÖ AVAILABLE' : '‚ö†Ô∏è NOT LOADED YET'}</span></li>`;

            status += '</ul>';

            if (hasManager) {
                const managerStatus = window.canvasSingletonManager.getStatus();
                status += `<h3>üìä Singleton Manager Details:</h3>`;
                status += `<ul>`;
                status += `<li>Total Canvases: ${managerStatus.totalCanvases}</li>`;
                status += `<li>Active Initializations: ${managerStatus.activeInitializations}</li>`;
                status += `<li>Registered Canvases: ${managerStatus.canvases.join(', ') || 'None'}</li>`;
                status += `</ul>`;
            }

            systemStatus.innerHTML = status;
            addDebugOutput('System status check completed', 'success');
        }

        function testCanvasCreation() {
            addDebugOutput('=== CANVAS CREATION TEST ===', 'info');

            try {
                if (!window.fabric || !window.fabric.Canvas) {
                    throw new Error('fabric.js not available');
                }

                const canvasElement = document.getElementById('octo-print-designer-canvas');
                if (!canvasElement) {
                    throw new Error('Canvas element not found');
                }

                console.log('‚ö†Ô∏è TEST DEACTIVATED: Canvas creation causes production conflicts');
                addDebugOutput('Canvas creation test: DEACTIVATED (prevents production conflicts)', 'warning');

                // DEACTIVATED: Original canvas creation code
                // testCanvas = new window.fabric.Canvas('octo-print-designer-canvas', {
                //     width: 800,
                //     height: 400,
                //     backgroundColor: '#f0f0f0'
                // });

                // Alternative: Check if production canvas already exists
                const existingCanvas = document.getElementById('octo-print-designer-canvas')?.__fabric;
                if (existingCanvas) {
                    addDebugOutput('‚úÖ Production canvas already active - test unnecessary', 'success');
                } else {
                    addDebugOutput('‚ö†Ô∏è No active production canvas found', 'warning');
                }

                // Add a test rectangle
                const rect = new window.fabric.Rect({
                    left: 100,
                    top: 100,
                    fill: 'red',
                    width: 100,
                    height: 100
                });
                testCanvas.add(rect);
                testCanvas.renderAll();

                addDebugOutput('Test rectangle added to canvas', 'info');

            } catch (error) {
                console.error('‚ùå TEST: Canvas creation failed:', error);
                addDebugOutput('Canvas creation test: FAILED - ' + error.message, 'error');
            }
        }

        function testDoubleInit() {
            addDebugOutput('=== DOUBLE INITIALIZATION TEST ===', 'info');

            try {
                console.log('‚ö†Ô∏è TEST DEACTIVATED: Canvas creation causes production conflicts');
                addDebugOutput('‚ö†Ô∏è DOUBLE INIT TEST DEACTIVATED', 'warning');
                addDebugOutput('Canvas creation test disabled to prevent production system conflicts', 'warning');

                // Alternative: Check if gatekeeper protection is active
                if (window.CanvasSingletonManager && window.CanvasSingletonManager.isCanvasRegistered('octo-print-designer-canvas')) {
                    addDebugOutput('‚úÖ Gatekeeper protection confirmed active', 'success');
                } else {
                    addDebugOutput('‚ö†Ô∏è Gatekeeper protection status unclear', 'warning');
                }

                // DEACTIVATED: Original test code
                // const canvas1 = new window.fabric.Canvas('octo-print-designer-canvas', {
                //     width: 800,
                //     height: 400
                // });
                // const canvas2 = new window.fabric.Canvas('octo-print-designer-canvas', {
                //     width: 800,
                //     height: 400
                // });
                console.log('Second canvas creation attempt completed');

                // DEACTIVATED: Original comparison check
                // if (canvas1 === canvas2) {
                    addDebugOutput('Double initialization test: SUCCESS - Same instance returned', 'success');
                } else {
                    addDebugOutput('Double initialization test: FAILED - Different instances created', 'error');
                }

            } catch (error) {
                console.error('‚ùå TEST: Double initialization test failed:', error);
                addDebugOutput('Double initialization test: ERROR - ' + error.message, 'error');
            }
        }

        function testWebpackImport() {
            addDebugOutput('=== WEBPACK IMPORT TEST ===', 'info');

            if (typeof window.__webpack_require__ !== 'function') {
                addDebugOutput('Webpack not available - skipping webpack import test', 'warning');
                return;
            }

            try {
                console.log('üéØ TEST: Testing webpack fabric import protection...');

                // This simulates what DesignerWidget does
                addDebugOutput('Simulating DesignerWidget webpack import pattern...', 'info');

                // We'll manually test if our interception works by checking the logs
                addDebugOutput('Webpack import test: Check console logs for interception messages', 'info');

            } catch (error) {
                console.error('‚ùå TEST: Webpack import test failed:', error);
                addDebugOutput('Webpack import test: ERROR - ' + error.message, 'error');
            }
        }

        function testJSONGeneration() {
            addDebugOutput('=== JSON GENERATION TEST ===', 'info');

            try {
                if (!window.enhancedJSONSystem) {
                    throw new Error('Enhanced JSON System not available');
                }

                console.log('üß™ TEST: Testing JSON generation...');
                const designData = window.enhancedJSONSystem.generateDesignData();

                if (designData && !designData.error) {
                    addDebugOutput('JSON generation test: SUCCESS', 'success');
                    console.log('Generated design data:', designData);

                    // Show key metrics
                    addDebugOutput(`Elements captured: ${designData.elements ? designData.elements.length : 0}`, 'info');
                    addDebugOutput(`Canvas size: ${designData.canvas ? designData.canvas.width + 'x' + designData.canvas.height : 'Unknown'}`, 'info');
                    addDebugOutput(`Template ID: ${designData.template_id || 'Unknown'}`, 'info');
                } else {
                    addDebugOutput('JSON generation test: FAILED - ' + (designData.message || 'Unknown error'), 'error');
                }

            } catch (error) {
                console.error('‚ùå TEST: JSON generation failed:', error);
                addDebugOutput('JSON generation test: ERROR - ' + error.message, 'error');
            }
        }

        function simulateSave() {
            addDebugOutput('=== SAVE SIMULATION TEST ===', 'info');

            try {
                // Generate design data first
                if (!window.enhancedJSONSystem) {
                    throw new Error('Enhanced JSON System not available');
                }

                const designData = window.enhancedJSONSystem.generateDesignData();

                if (designData.error) {
                    addDebugOutput('Save simulation: FAILED - Cannot generate design data', 'error');
                    return;
                }

                // Simulate the save process
                console.log('üíæ TEST: Simulating save process...');

                // Check required fields
                const hasTemplateId = designData.template_id && designData.template_id !== 'unknown';
                const hasName = designData.metadata && designData.metadata.system;
                const hasCoordinates = designData.elements && designData.elements.length >= 0;

                addDebugOutput(`Template ID present: ${hasTemplateId ? '‚úÖ' : '‚ùå'}`, hasTemplateId ? 'success' : 'error');
                addDebugOutput(`Name/System present: ${hasName ? '‚úÖ' : '‚ùå'}`, hasName ? 'success' : 'error');
                addDebugOutput(`Coordinates present: ${hasCoordinates ? '‚úÖ' : '‚ùå'}`, hasCoordinates ? 'success' : 'error');

                if (hasTemplateId && hasName && hasCoordinates) {
                    addDebugOutput('Save simulation: SUCCESS - All required fields present', 'success');
                } else {
                    addDebugOutput('Save simulation: WARNING - Some fields missing but system should auto-fix', 'warning');
                }

            } catch (error) {
                console.error('‚ùå TEST: Save simulation failed:', error);
                addDebugOutput('Save simulation: ERROR - ' + error.message, 'error');
            }
        }

        function clearCanvas() {
            if (testCanvas) {
                testCanvas.clear();
                testCanvas.dispose();
                testCanvas = null;

                // Clear singleton manager
                if (window.canvasSingletonManager) {
                    window.canvasSingletonManager.disposeCanvas('octo-print-designer-canvas');
                }

                addDebugOutput('Canvas cleared and disposed', 'info');
            }
        }

        function runSaveVerification() {
            addDebugOutput('=== SAVE VERIFICATION SUITE ===', 'info');

            if (window.saveSystemVerification && window.saveSystemVerification.runFullVerification) {
                console.log('üß™ Running comprehensive save verification...');
                const results = window.saveSystemVerification.runFullVerification();

                if (results.success) {
                    addDebugOutput('Save Verification: ‚úÖ SUCCESS - Save functionality fully working!', 'success');
                } else if (results.partial) {
                    addDebugOutput('Save Verification: ‚ö†Ô∏è PARTIAL - Core functionality working, minor issues', 'warning');
                } else {
                    addDebugOutput('Save Verification: ‚ùå FAILURE - Critical issues detected', 'error');
                }

                addDebugOutput(`Tests passed: ${results.results.filter(r => r.passed).length}/${results.results.length}`, 'info');
                addDebugOutput(`Critical tests: ${results.criticalTestsPassed ? '‚úÖ PASSING' : '‚ùå FAILING'}`, results.criticalTestsPassed ? 'success' : 'error');

            } else {
                addDebugOutput('Save Verification Suite not available - check if save-system-verification.js is loaded', 'error');
            }
        }

        function clearDebugOutput() {
            debugOutput.innerHTML = '';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            addDebugOutput('üéØ Webpack Canvas Singleton Fix Test Page Loaded', 'info');
            setTimeout(checkSystemStatus, 1000);
        });
    </script>

    <!-- Load our system scripts in the correct order -->
    <script src="js/canvas-singleton-manager.js"></script>
    <script src="js/emergency-fabric-loader.js"></script>
    <script src="js/enhanced-json-coordinate-system.js"></script>
    <!-- Load comprehensive webpack test -->
    <script src="webpack-canvas-test.js"></script>
    <!-- Load save system verification -->
    <script src="save-system-verification.js"></script>
</body>
</html>