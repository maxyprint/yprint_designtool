<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ YPrint Core Rebuild Testing Interface</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .test-card.passed {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.2);
        }

        .test-card.failed {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .test-card.running {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .test-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-description {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .test-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .test-details {
            font-size: 0.8em;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-size: 1.1em;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .canvas-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .canvas-container canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 30px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2ecc71;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ YPrint Core Rebuild Testing</h1>
            <p>Comprehensive validation of the new core architecture</p>
        </div>

        <div class="performance-stats" id="performance-stats">
            <div class="stat-card">
                <div class="stat-value" id="script-count">4</div>
                <div class="stat-label">Scripts Loaded</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="load-time">-</div>
                <div class="stat-label">Load Time (ms)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="memory-usage">-</div>
                <div class="stat-label">Memory Usage</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="legacy-scripts">0</div>
                <div class="stat-label">Legacy Scripts</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="runAllTests()">
                üß™ Run All Tests
            </button>
            <button class="btn btn-secondary" onclick="runPerformanceTest()">
                üìä Performance Test
            </button>
            <button class="btn btn-secondary" onclick="runStressTest()">
                üî• Stress Test
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>

        <div class="test-grid" id="test-grid">
            <!-- Test cards will be populated by JavaScript -->
        </div>

        <div class="canvas-container">
            <h3 style="color: #333;">Live Designer Test</h3>
            <canvas id="test-canvas" width="600" height="400"></canvas>
            <p style="color: #666;">Canvas should show fabric.js functionality if core rebuild is working</p>
        </div>

        <div class="log-container" id="log-container">
            <div class="log-entry log-info">üöÄ Core Rebuild Testing Interface Ready</div>
        </div>
    </div>

    <!-- Load the core rebuild scripts in order -->
    <script src="public/js/unified-fabric-core.js"></script>
    <script src="public/js/designer-widget-core.js"></script>
    <script src="public/js/yprint-unified-api.js"></script>
    <script src="public/js/yprint-wordpress-integration.js"></script>

    <script>
        // Test Framework
        class CoreRebuildTester {
            constructor() {
                this.tests = [
                    { name: 'Unified Fabric Core', icon: 'üéØ', test: this.testUnifiedFabricCore.bind(this) },
                    { name: 'Designer Widget Core', icon: 'üé®', test: this.testDesignerWidgetCore.bind(this) },
                    { name: 'YPrint Unified API', icon: 'üöÄ', test: this.testYPrintUnifiedAPI.bind(this) },
                    { name: 'WordPress Integration', icon: 'üîó', test: this.testWordPressIntegration.bind(this) },
                    { name: 'Canvas Creation', icon: 'üñºÔ∏è', test: this.testCanvasCreation.bind(this) },
                    { name: 'Element Management', icon: 'üì¶', test: this.testElementManagement.bind(this) },
                    { name: 'Design Data Flow', icon: 'üíæ', test: this.testDesignDataFlow.bind(this) },
                    { name: 'Event System', icon: '‚ö°', test: this.testEventSystem.bind(this) },
                    { name: 'Legacy Compatibility', icon: 'üîÑ', test: this.testLegacyCompatibility.bind(this) },
                    { name: 'Performance Metrics', icon: 'üìä', test: this.testPerformanceMetrics.bind(this) }
                ];

                this.results = new Map();
                this.startTime = performance.now();

                this.setupUI();
                this.setupEventListeners();
                this.startPerformanceMonitoring();
            }

            setupUI() {
                this.renderTestCards();
                this.updateStats();
            }

            renderTestCards() {
                const grid = document.getElementById('test-grid');
                grid.innerHTML = '';

                this.tests.forEach((test, index) => {
                    const card = document.createElement('div');
                    card.className = 'test-card';
                    card.id = `test-${index}`;
                    card.innerHTML = `
                        <div class="test-title">
                            <span>${test.icon}</span>
                            <span>${test.name}</span>
                        </div>
                        <div class="test-description">Testing ${test.name.toLowerCase()} functionality</div>
                        <div class="test-status" id="status-${index}">Pending</div>
                        <div class="test-details" id="details-${index}" style="display: none;"></div>
                    `;
                    grid.appendChild(card);
                });
            }

            setupEventListeners() {
                // Listen for core system events
                window.addEventListener('unifiedFabricReady', () => {
                    this.log('success', '‚úÖ Unified Fabric Core Ready');
                });

                window.addEventListener('designerWidgetReady', () => {
                    this.log('success', '‚úÖ Designer Widget Core Ready');
                });

                window.addEventListener('yprintSystemReady', () => {
                    this.log('success', '‚úÖ YPrint Unified API Ready');
                });

                window.addEventListener('yprintWordPressReady', () => {
                    this.log('success', '‚úÖ WordPress Integration Ready');
                });
            }

            startPerformanceMonitoring() {
                // Monitor memory usage
                if (performance.memory) {
                    setInterval(() => {
                        const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                        document.getElementById('memory-usage').textContent = memoryMB + 'MB';
                    }, 1000);
                }

                // Update load time
                const loadTime = Math.round(performance.now() - this.startTime);
                document.getElementById('load-time').textContent = loadTime;
            }

            async runAllTests() {
                this.log('info', 'üß™ Starting comprehensive core rebuild tests...');

                for (let i = 0; i < this.tests.length; i++) {
                    const test = this.tests[i];
                    await this.runSingleTest(i, test);
                }

                this.generateSummaryReport();
            }

            async runSingleTest(index, test) {
                const card = document.getElementById(`test-${index}`);
                const status = document.getElementById(`status-${index}`);
                const details = document.getElementById(`details-${index}`);

                try {
                    // Mark as running
                    card.className = 'test-card running';
                    status.textContent = 'Running...';
                    status.style.backgroundColor = '#f39c12';

                    this.log('info', `üîÑ Running test: ${test.name}`);

                    // Run the test
                    const result = await test.test();

                    // Mark as passed
                    if (result.passed) {
                        card.className = 'test-card passed';
                        status.textContent = 'PASSED';
                        status.style.backgroundColor = '#27ae60';
                        this.log('success', `‚úÖ ${test.name}: ${result.message}`);
                    } else {
                        throw new Error(result.message);
                    }

                    // Show details
                    if (result.details) {
                        details.innerHTML = JSON.stringify(result.details, null, 2);
                        details.style.display = 'block';
                    }

                    this.results.set(test.name, result);

                } catch (error) {
                    // Mark as failed
                    card.className = 'test-card failed';
                    status.textContent = 'FAILED';
                    status.style.backgroundColor = '#e74c3c';

                    details.innerHTML = error.message;
                    details.style.display = 'block';

                    this.log('error', `‚ùå ${test.name}: ${error.message}`);
                    this.results.set(test.name, { passed: false, message: error.message });
                }

                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Individual Test Methods
            async testUnifiedFabricCore() {
                if (!window.unifiedFabricCore) {
                    throw new Error('Unified Fabric Core not found');
                }

                const status = window.unifiedFabricCore.getStatus();

                if (!status.initialized) {
                    throw new Error('Unified Fabric Core not initialized');
                }

                if (!status.fabricReady) {
                    throw new Error('Fabric.js not ready');
                }

                return {
                    passed: true,
                    message: `Core initialized with fabric v${status.fabricVersion}`,
                    details: status
                };
            }

            async testDesignerWidgetCore() {
                if (!window.designerWidgetCore) {
                    throw new Error('Designer Widget Core not found');
                }

                const status = window.designerWidgetCore.getStatus();

                if (!status.initialized) {
                    throw new Error('Designer Widget not initialized');
                }

                if (!status.canvasReady) {
                    throw new Error('Canvas not ready');
                }

                return {
                    passed: true,
                    message: `Designer widget ready with ${status.elementCount} elements`,
                    details: status
                };
            }

            async testYPrintUnifiedAPI() {
                if (!window.YPrint) {
                    throw new Error('YPrint Unified API not found');
                }

                if (!window.yprintUnifiedAPI?.initialized) {
                    throw new Error('YPrint API not initialized');
                }

                const status = window.yprintUnifiedAPI.getSystemStatus();

                return {
                    passed: true,
                    message: `API v${status.version} ready with ${status.coreRebuild ? 'core rebuild' : 'legacy'}`,
                    details: status
                };
            }

            async testWordPressIntegration() {
                if (!window.yprintWordPressIntegration) {
                    throw new Error('WordPress Integration not found');
                }

                const status = window.yprintWordPressIntegration.getStatus();

                return {
                    passed: true,
                    message: `WordPress integration ready (Product ID: ${status.productId || 'N/A'})`,
                    details: status
                };
            }

            async testCanvasCreation() {
                const testCanvas = window.unifiedFabricCore.createCanvas('test-canvas', {
                    width: 600,
                    height: 400,
                    backgroundColor: '#f0f0f0'
                });

                if (!testCanvas) {
                    throw new Error('Failed to create test canvas');
                }

                return {
                    passed: true,
                    message: `Canvas created successfully (${testCanvas.width}x${testCanvas.height})`,
                    details: { width: testCanvas.width, height: testCanvas.height }
                };
            }

            async testElementManagement() {
                const designer = window.YPrint.designer;

                // Add test elements
                const textElement = designer.addElement('text', { text: 'Test Text', x: 50, y: 50 });
                const rectElement = designer.addElement('rectangle', { width: 100, height: 100, x: 200, y: 50 });

                if (!textElement || !rectElement) {
                    throw new Error('Failed to create test elements');
                }

                const canvas = designer.getCanvas();
                const elementCount = canvas.getObjects().length;

                return {
                    passed: true,
                    message: `Created ${elementCount} test elements successfully`,
                    details: { elementCount, textId: textElement.id, rectId: rectElement.id }
                };
            }

            async testDesignDataFlow() {
                const designData = window.YPrint.design.getData();

                if (!designData) {
                    throw new Error('Failed to get design data');
                }

                const coordinates = window.YPrint.design.getCoordinates();
                const validation = window.YPrint.design.validate();

                return {
                    passed: true,
                    message: `Design data flow working (${coordinates.length} elements, validation: ${validation.valid})`,
                    details: { elementCount: coordinates.length, valid: validation.valid }
                };
            }

            async testEventSystem() {
                let eventReceived = false;

                const handler = () => { eventReceived = true; };
                window.addEventListener('testEvent', handler, { once: true });
                window.dispatchEvent(new CustomEvent('testEvent'));

                await new Promise(resolve => setTimeout(resolve, 100));

                if (!eventReceived) {
                    throw new Error('Event system not working');
                }

                return {
                    passed: true,
                    message: 'Event system working correctly',
                    details: { eventReceived }
                };
            }

            async testLegacyCompatibility() {
                // Test legacy globals
                const legacyGlobals = {
                    designerWidgetInstance: !!window.designerWidgetInstance,
                    detectCanvasParadox: typeof window.detectCanvasParadox === 'function',
                    logCoordinateSystemOutput: typeof window.logCoordinateSystemOutput === 'function'
                };

                const compatibilityScore = Object.values(legacyGlobals).filter(Boolean).length;

                return {
                    passed: compatibilityScore >= 2,
                    message: `Legacy compatibility: ${compatibilityScore}/3 globals available`,
                    details: legacyGlobals
                };
            }

            async testPerformanceMetrics() {
                const startTime = performance.now();

                // Test canvas rendering performance
                const canvas = window.YPrint.designer.getCanvas();
                canvas.renderAll();

                const renderTime = performance.now() - startTime;

                const memoryUsage = performance.memory ?
                    Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 'N/A';

                return {
                    passed: renderTime < 50, // Should render in under 50ms
                    message: `Render time: ${renderTime.toFixed(2)}ms, Memory: ${memoryUsage}MB`,
                    details: { renderTime, memoryUsage }
                };
            }

            // Utility Methods
            generateSummaryReport() {
                const totalTests = this.tests.length;
                const passedTests = Array.from(this.results.values()).filter(r => r.passed).length;
                const successRate = Math.round((passedTests / totalTests) * 100);

                this.log('info', `üìä Test Summary: ${passedTests}/${totalTests} passed (${successRate}%)`);

                if (successRate >= 90) {
                    this.log('success', 'üéâ Core rebuild EXCELLENT - Production ready!');
                } else if (successRate >= 80) {
                    this.log('success', '‚úÖ Core rebuild GOOD - Minor issues to address');
                } else if (successRate >= 70) {
                    this.log('warning', '‚ö†Ô∏è Core rebuild ACCEPTABLE - Several issues found');
                } else {
                    this.log('error', '‚ùå Core rebuild POOR - Major issues need fixing');
                }
            }

            updateStats() {
                // Count actual scripts loaded
                const scripts = document.querySelectorAll('script[src]');
                const coreScripts = Array.from(scripts).filter(script =>
                    script.src.includes('unified-fabric-core') ||
                    script.src.includes('designer-widget-core') ||
                    script.src.includes('yprint-unified-api') ||
                    script.src.includes('yprint-wordpress-integration')
                );

                document.getElementById('script-count').textContent = coreScripts.length;
            }

            log(type, message) {
                const logContainer = document.getElementById('log-container');
                const timestamp = new Date().toLocaleTimeString();
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry log-${type}`;
                logDiv.innerHTML = `[${timestamp}] ${message}`;
                logContainer.appendChild(logDiv);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Global functions for buttons
        let tester;

        window.runAllTests = function() {
            if (!tester) {
                tester = new CoreRebuildTester();
            }
            tester.runAllTests();
        };

        window.runPerformanceTest = function() {
            if (!tester) {
                tester = new CoreRebuildTester();
            }
            tester.runSingleTest(9, tester.tests[9]); // Performance test
        };

        window.runStressTest = function() {
            tester.log('info', 'üî• Running stress test...');

            // Add many elements rapidly
            for (let i = 0; i < 100; i++) {
                window.YPrint.designer.addElement('circle', {
                    x: Math.random() * 500,
                    y: Math.random() * 300,
                    radius: 10,
                    color: `hsl(${Math.random() * 360}, 70%, 50%)`
                });
            }

            tester.log('success', '‚úÖ Stress test completed - 100 elements added');
        };

        window.clearResults = function() {
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('test-grid').innerHTML = '';
            if (tester) {
                tester.results.clear();
                tester.renderTestCards();
            }
        };

        // Auto-initialize when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                tester = new CoreRebuildTester();
                tester.log('info', 'üöÄ Core Rebuild Testing Interface Ready');
                tester.log('info', 'üí° Click "Run All Tests" to validate the core rebuild');
            }, 1000);
        });
    </script>
</body>
</html>