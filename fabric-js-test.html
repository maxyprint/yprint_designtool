<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Fabric.js Availability Test</title>
</head>
<body>
    <h1>üéØ FABRIC.JS EMERGENCY FIX TEST</h1>

    <div id="test-container">
        <div class="octo-print-designer">
            <!-- Simulated designer container with required structure -->
            <div class="canvas-container">
                <canvas id="main-canvas" width="800" height="600"></canvas>
            </div>
            <div class="toolbar-container"></div>
            <div class="modal-container"></div>
            <div class="toast-container"></div>
        </div>
    </div>

    <style>
        .octo-print-designer {
            width: 800px;
            height: 600px;
            border: 2px solid #ccc;
            margin: 20px 0;
            position: relative;
        }
        .canvas-container {
            width: 100%;
            height: 100%;
        }
        #main-canvas {
            border: 1px solid #ddd;
        }
    </style>

    <div id="results">
        <h2>Test Results:</h2>
        <div id="log"></div>
    </div>

    <script>
        const log = document.getElementById('log');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.style.margin = '5px 0';
            div.style.padding = '5px';
            div.style.backgroundColor = type === 'success' ? '#d4edda' :
                                      type === 'error' ? '#f8d7da' : '#e2e3e5';
            div.textContent = message;
            log.appendChild(div);
            console.log(message);
        }

        // Test sequence
        addLog('üöÄ Starting Fabric.js Emergency Fix Test...');

        // Check initial state
        addLog(`Initial Fabric.js state: ${typeof window.fabric !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}`);

        // Listen for fabricGlobalReady event
        document.addEventListener('fabricGlobalReady', function(event) {
            addLog('üéØ fabricGlobalReady event received!', 'success');
            addLog(`Event source: ${event.detail.source}`, 'info');
            addLog(`Fabric.js now available: ${typeof window.fabric !== 'undefined' ? '‚úÖ YES' : '‚ùå NO'}`,
                   typeof window.fabric !== 'undefined' ? 'success' : 'error');
        });

        // Listen for designerReady event
        document.addEventListener('designerReady', function(event) {
            addLog('üéØ designerReady event received!', 'success');
            addLog(`Designer instance: ${event.detail.instance ? '‚úÖ Available' : '‚ùå Missing'}`,
                   event.detail.instance ? 'success' : 'error');
        });
    </script>

    <!-- Load the designer bundle that should trigger the Fabric.js fix -->
    <script src="./public/js/dist/designer.bundle.js"></script>

    <!-- Load the optimized capture system to test coordination -->
    <script src="./public/js/optimized-design-data-capture.js"></script>

    <script>
        // Test after bundle loads
        setTimeout(() => {
            addLog('--- POST-LOAD TEST RESULTS ---');
            addLog(`window.fabric available: ${typeof window.fabric !== 'undefined' ? '‚úÖ YES' : '‚ùå NO'}`,
                   typeof window.fabric !== 'undefined' ? 'success' : 'error');
            addLog(`DesignerWidget instance: ${window.designerWidgetInstance ? '‚úÖ Available' : '‚ùå Missing'}`,
                   window.designerWidgetInstance ? 'success' : 'error');
            addLog(`fabricCanvas: ${window.designerWidgetInstance?.fabricCanvas ? '‚úÖ Available' : '‚ùå Missing'}`,
                   window.designerWidgetInstance?.fabricCanvas ? 'success' : 'error');

            // Test coordinate generation if available
            if (window.generateDesignData) {
                try {
                    const result = window.generateDesignData();
                    addLog(`Coordinate generation: ${result.elements ? '‚úÖ SUCCESS' : '‚ö†Ô∏è NO ELEMENTS'}`,
                           result.elements ? 'success' : 'error');
                } catch (e) {
                    addLog(`Coordinate generation: ‚ùå ERROR - ${e.message}`, 'error');
                }
            } else {
                addLog('Coordinate generation function: ‚ùå Not Available', 'error');
            }
        }, 1000);
    </script>
</body>
</html>