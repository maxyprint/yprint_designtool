<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Multi-View PNG System - Vollst√§ndiger Test</title>
    <style>
        body {
            font-family: 'Segoe UI', monospace, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .test-section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .debug-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .debug-card h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
        }

        .mock-canvas {
            width: 300px;
            height: 200px;
            border: 2px dashed #007bff;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #007bff;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Multi-View PNG System - Robuste Implementierung Test</h1>

        <div class="test-section">
            <h2>üìã Test-Szenario</h2>
            <p><strong>Ziel:</strong> Multi-View PNG System mit robuster Dependency Detection und automatischer View-Erkennung</p>
            <ul>
                <li>‚úÖ Script Loading: multi-view-png-system.js</li>
                <li>‚úÖ Dependency Detection: window.designerInstance + window.saveOnlyPNGGenerator</li>
                <li>‚úÖ Event Handling: designerReady Event + Polling Fallback</li>
                <li>‚úÖ View System Integration: Template/View Detection</li>
                <li>‚úÖ PNG Generation: Nur f√ºr Views mit Inhalt</li>
            </ul>
        </div>

        <div id="status" class="status loading">üîÑ Initialisierung l√§uft...</div>

        <div class="debug-grid">
            <div class="debug-card">
                <h3>üîß Dependency Status</h3>
                <div id="dependencies">Wird geladen...</div>
            </div>

            <div class="debug-card">
                <h3>üé® Designer Status</h3>
                <div id="designer-status">Wird gepr√ºft...</div>
            </div>

            <div class="debug-card">
                <h3>üìÑ Template System</h3>
                <div id="template-status">Wird analysiert...</div>
            </div>

            <div class="debug-card">
                <h3>üñºÔ∏è View Content Detection</h3>
                <div id="content-status">Wird ermittelt...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Interactive Testing</h3>
            <button onclick="testDependencies()">Check Dependencies</button>
            <button onclick="testViewDetection()">Test View Detection</button>
            <button onclick="testPNGGeneration()">Test PNG Generation</button>
            <button onclick="simulateDesignerReady()">Simulate designerReady Event</button>
            <button onclick="fullSystemTest()">üöÄ Full System Test</button>

            <div class="mock-canvas">
                Mock Designer Canvas
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Live Console Output</h3>
            <div id="console-log" class="log-container"></div>
            <button onclick="clearConsole()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üîç Debug Information</h3>
            <pre id="debug-info">Wird geladen...</pre>
        </div>
    </div>

    <script>
        // Mock Designer Environment f√ºr Tests
        window.mockDesignerEnvironment = {
            setupBasicDependencies() {
                console.log('üé≠ MOCK: Setting up basic designer dependencies...');

                // Mock designerInstance
                if (!window.designerInstance) {
                    window.designerInstance = {
                        fabricCanvas: {
                            getObjects: () => [
                                { type: 'text', text: 'Sample Text', visible: true },
                                { type: 'image', src: 'user-upload.jpg', visible: true, width: 100, height: 100 }
                            ],
                            renderAll: () => console.log('üé® Canvas rendered'),
                            on: (event, handler) => console.log(`üé® Event listener added: ${event}`)
                        },
                        currentView: 'front',
                        templates: {
                            'template_3657': {
                                views: {
                                    '189542': { name: 'Front', printArea: { x: 100, y: 100, width: 230, height: 351 } },
                                    '679311': { name: 'Back', printArea: { x: 100, y: 100, width: 222, height: 321 } }
                                }
                            }
                        },
                        switchView: (viewId) => {
                            console.log(`üîÑ Mock view switch to: ${viewId}`);
                            window.designerInstance.currentView = viewId;
                            return Promise.resolve();
                        }
                    };
                    console.log('‚úÖ MOCK: designerInstance created');
                }

                // Mock saveOnlyPNGGenerator
                if (!window.saveOnlyPNGGenerator) {
                    window.saveOnlyPNGGenerator = {
                        initialized: true,
                        generatePNG: async (options = {}) => {
                            console.log('üé® MOCK PNG Generation:', options);
                            return {
                                success: true,
                                dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                                viewId: options.viewId || 'current',
                                viewName: options.viewName || 'Current View'
                            };
                        }
                    };
                    console.log('‚úÖ MOCK: saveOnlyPNGGenerator created');
                }
            },

            simulateDesignerReady() {
                console.log('üéØ MOCK: Simulating designerReady event...');
                this.setupBasicDependencies();

                setTimeout(() => {
                    const event = new CustomEvent('designerReady', {
                        detail: { source: 'mock', timestamp: new Date().toISOString() }
                    });
                    window.dispatchEvent(event);
                    console.log('‚úÖ MOCK: designerReady event dispatched');
                }, 100);
            }
        };

        // Console Logging Override f√ºr Live-Output
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function logToUI(message, type = 'log') {
            const logContainer = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'color: #ff6b6b' :
                              type === 'warn' ? 'color: #feca57' : 'color: #00ff00';

            logContainer.innerHTML += `<div style="${colorClass}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToUI(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToUI('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToUI('WARN: ' + args.join(' '), 'warn');
        };

        // Test Functions
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function testDependencies() {
            console.log('üß™ TEST: Checking dependencies...');

            if (window.multiViewPNGDebug) {
                const deps = window.multiViewPNGDebug.checkDependencies();
                document.getElementById('dependencies').innerHTML = `
                    <strong>Designer Widget:</strong> ${deps.designerWidget ? '‚úÖ' : '‚ùå'}<br>
                    <strong>PNG Generator:</strong> ${deps.saveOnlyPNGGenerator ? '‚úÖ' : '‚ùå'}<br>
                    <strong>Initialized:</strong> ${deps.initialized ? '‚úÖ' : '‚ùå'}<br>
                    <strong>Templates:</strong> ${deps.templates}<br>
                    <strong>Has Content:</strong> ${deps.hasContent}
                `;
                updateStatus('‚úÖ Dependencies checked', 'success');
            } else {
                document.getElementById('dependencies').innerHTML = '‚ùå Multi-View system not loaded';
                updateStatus('‚ùå Multi-View system not available', 'error');
            }
        }

        function testViewDetection() {
            console.log('üß™ TEST: Testing view detection...');

            if (window.multiViewPNGSystem) {
                window.multiViewPNGSystem.updateViewContentStatus();
                const info = window.multiViewPNGSystem.getDebugInfo();

                document.getElementById('content-status').innerHTML = `
                    <strong>Current View:</strong> ${info.currentView}<br>
                    <strong>Content Status:</strong> ${JSON.stringify(info.contentStatus)}<br>
                    <strong>Has Content:</strong> ${info.hasContent}
                `;
                updateStatus('‚úÖ View detection tested', 'success');
            } else {
                updateStatus('‚ùå Multi-View system not initialized', 'error');
            }
        }

        async function testPNGGeneration() {
            console.log('üß™ TEST: Testing PNG generation...');

            if (window.multiViewPNGSystem) {
                try {
                    const result = await window.multiViewPNGSystem.generateMultiViewPNGs();
                    console.log('üéØ PNG Generation Result:', result);
                    updateStatus('‚úÖ PNG generation completed', 'success');
                } catch (error) {
                    console.error('PNG generation failed:', error);
                    updateStatus('‚ùå PNG generation failed', 'error');
                }
            } else {
                updateStatus('‚ùå Multi-View system not available', 'error');
            }
        }

        function simulateDesignerReady() {
            console.log('üß™ TEST: Simulating designerReady event...');
            window.mockDesignerEnvironment.simulateDesignerReady();
        }

        async function fullSystemTest() {
            console.log('üöÄ FULL SYSTEM TEST: Starting comprehensive test...');
            updateStatus('üöÄ Running full system test...', 'loading');

            // Setup mock environment
            window.mockDesignerEnvironment.setupBasicDependencies();

            // Wait for system to initialize
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Test all components
            testDependencies();
            testViewDetection();
            await testPNGGeneration();

            updateStatus('üéØ Full system test completed', 'success');
        }

        function clearConsole() {
            document.getElementById('console-log').innerHTML = '';
        }

        function updateDebugInfo() {
            if (window.multiViewPNGDebug) {
                const info = window.multiViewPNGDebug.getInfo();
                document.getElementById('debug-info').textContent = JSON.stringify(info, null, 2);
            } else {
                document.getElementById('debug-info').textContent = 'Multi-View system not loaded yet...';
            }
        }

        // Initialization
        window.addEventListener('load', () => {
            console.log('üéØ TEST PAGE: Loaded, setting up mock environment...');

            // Setup basic mock environment
            window.mockDesignerEnvironment.setupBasicDependencies();

            // Regular updates
            setInterval(() => {
                testDependencies();
                updateDebugInfo();
            }, 2000);

            updateStatus('‚úÖ Test environment ready', 'success');
        });

        // Auto-run full test after 3 seconds
        setTimeout(() => {
            console.log('üöÄ AUTO-TEST: Running automatic full system test...');
            fullSystemTest();
        }, 3000);
    </script>

    <!-- Load the actual multi-view PNG system -->
    <script src="public/js/save-only-png-generator.js"></script>
    <script src="public/js/multi-view-png-system.js"></script>
</body>
</html>